name: HTML Validation

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  html-validate:
    name: Validate HTML & Accessibility
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --ignore-scripts
      
      - name: Install html-validate
        run: npm install --save-dev html-validate
      
      - name: Build site with Eleventy
        run: npm run build
      
      - name: Validate HTML syntax
        run: npx html-validate "_site/**/*.html"
      
      - name: Check accessibility with pa11y
        run: |
          # Start local server in background
          npm run serve &
          SERVER_PID=$!
          
          # Wait for server to start
          echo "Waiting for server to start..."
          sleep 5
          
          # Check if server is running
          if ! curl -f http://localhost:8000 > /dev/null 2>&1; then
            echo "Error: Server failed to start"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi
          
          # Run accessibility checks on main pages
          echo "Running accessibility checks..."
          npx pa11y http://localhost:8000/index.html --threshold 0 --runner axe
          npx pa11y http://localhost:8000/about.html --threshold 0 --runner axe
          npx pa11y http://localhost:8000/publications.html --threshold 0 --runner axe
          npx pa11y http://localhost:8000/blog.html --threshold 0 --runner axe
          npx pa11y http://localhost:8000/contact.html --threshold 0 --runner axe
          
          # Stop server
          kill $SERVER_PID 2>/dev/null || true
          
          echo "âœ… Accessibility checks passed!"
