---
name: Link Checker

# Run on pull requests and on a schedule
'on':
  pull_request:
    branches:
      - main
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering

jobs:
  link-check:
    name: Check Links
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required to checkout the repository
      issues: write  # Required to create issues on failure

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Link Checker
        uses: lycheeverse/lychee-action@v1.10.0
        with:
          # Check all HTML files in the built site
          args: >-
            --verbose
            --no-progress
            --accept 200,204,206,301,302,307,308,429
            --exclude-mail
            --exclude 'linkedin\.com'
            --exclude 'twitter\.com'
            --exclude 'x\.com'
            --exclude 'facebook\.com'
            --exclude 'instagram\.com'
            --exclude 'youtube\.com'
            --exclude 'researchgate\.net'
            --exclude 'scholar\.google'
            --exclude 'orcid\.org'
            --timeout 20
            --max-retries 3
            --user-agent 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)
            AppleWebKit/537.36 (KHTML, like Gecko)
            Chrome/120.0.0.0 Safari/537.36'
            '_site/**/*.html'
          fail: true  # Fail the workflow if broken links are found
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const workflowUrl = `${context.serverUrl}/` +
              `${context.repo.owner}/${context.repo.repo}/` +
              `actions/runs/${context.runId}`;
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”— Broken Links Detected',
              body: `Automated link checking has detected ` +
                    `broken links in the website.\n\n` +
                    `**Workflow Run:** ${workflowUrl}\n\n` +
                    `Please review the workflow logs for details ` +
                    `about the broken links.`,
              labels: ['bug', 'automated']
            });
            console.log(`Created issue #${issue.data.number}`);
