---
name: Link Checker

# Run on pull requests and on a schedule
'on':
  pull_request:
    branches:
      - main
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering

jobs:
  link-check:
    name: Check Links
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required to checkout the repository
      issues: write  # Required to create issues on failure

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Link Checker (Strict)
        uses: lycheeverse/lychee-action@v1.10.0
        with:
          # Check all HTML files except problematic domains
          args: >-
            --verbose
            --no-progress
            --accept 200,204,206,301,302,307,308,403,429,503
            --exclude-mail
            --exclude-path '_site/blog/posts/assets'
            --exclude 'linkedin\.com'
            --exclude 'twitter\.com'
            --exclude 'x\.com'
            --exclude 'facebook\.com'
            --exclude 'instagram\.com'
            --exclude 'youtube\.com'
            --exclude 'researchgate\.net'
            --exclude 'scholar\.google'
            --exclude 'orcid\.org'
            --exclude 'googletagmanager\.com'
            --exclude 'fonts\.googleapis\.com'
            --exclude 'fonts\.gstatic\.com'
            --exclude 'tensorflow\.org'
            --exclude 'mathworks\.com'
            --exclude 'udacity\.com'
            --exclude 'coursera\.org'
            --exclude 'techrepublic\.com'
            --exclude 'tesla\.com'
            --exclude 'uber\.com'
            --exclude 'staff\.qut\.edu\.au'
            --exclude 'services\.anu\.edu\.au'
            --exclude 'dmi\.usherb\.ca'
            --exclude 'ri\.cmu\.edu/events/sb35'
            --exclude 'www3\.oculus\.com'
            --exclude 'webdiis\.unizar\.es'
            --exclude 'coraldrowningdetection\.com'
            --exclude 'talking\.papers\.podcast\.itzikbs\.com'
            --exclude 'jiajunwu\.com'
            --exclude 'people\.lu\.usi\.ch'
            --exclude 'cs\.ox\.ac\.uk/people/nando\.defreitas'
            --exclude '^file://'
            --timeout 45
            --max-retries 5
            --user-agent 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)
            AppleWebKit/537.36 (KHTML, like Gecko)
            Chrome/120.0.0.0 Safari/537.36'
            '_site/**/*.html'
          fail: true  # Fail the workflow if broken links are found
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Link Checker (Warn-Only for Flaky Domains)
        uses: lycheeverse/lychee-action@v1.10.0
        continue-on-error: true  # Don't fail the build on these problematic domains
        with:
          # Check only the problematic domains that have DNS/network issues in the runner
          args: >-
            --verbose
            --no-progress
            --accept 200,204,206,301,302,307,308,403,429,503
            --exclude-mail
            --include 'ri\.cmu\.edu/events/sb35'
            --include 'www3\.oculus\.com'
            --include 'webdiis\.unizar\.es'
            --include 'coraldrowningdetection\.com'
            --include 'talking\.papers\.podcast\.itzikbs\.com'
            --include 'jiajunwu\.com'
            --include 'people\.lu\.usi\.ch'
            --include 'cs\.ox\.ac\.uk/people/nando\.defreitas'
            --timeout 45
            --max-retries 5
            --user-agent 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)
            AppleWebKit/537.36 (KHTML, like Gecko)
            Chrome/120.0.0.0 Safari/537.36'
            '_site/**/*.html'
          fail: false  # Only log warnings, don't fail
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const workflowUrl = `${context.serverUrl}/` +
              `${context.repo.owner}/${context.repo.repo}/` +
              `actions/runs/${context.runId}`;
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”— Broken Links Detected',
              body: `Automated link checking has detected ` +
                    `broken links in the website.\n\n` +
                    `**Workflow Run:** ${workflowUrl}\n\n` +
                    `Please review the workflow logs for details ` +
                    `about the broken links.`,
              labels: ['bug', 'automated']
            });
            console.log(`Created issue #${issue.data.number}`);
