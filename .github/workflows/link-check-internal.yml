---
name: Link Checker (Internal) - PR

# This workflow checks ONLY internal links (relative paths and same-domain links)
# It runs on pull requests to catch broken internal links before merging
# External links are checked separately in the nightly workflow to avoid blocking PRs

'on':
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

jobs:
  internal-link-check:
    name: Check Internal Links Only
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required to checkout the repository
      pull-requests: write  # Required to comment on PRs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Check Internal Links
        uses: lycheeverse/lychee-action@v1.10.0
        with:
          # Check all links but exclude external problematic domains
          # This is simpler and more reliable than trying to filter internal vs external
          args: >-
            --verbose
            --no-progress
            --config lychee.toml
            --accept 200,204,206,301,302,307,308,403,429,503
            --exclude-path '_site/blog/posts/assets'
            --exclude 'github\.com'
            --exclude 'arxiv\.org'
            --exclude 'openaccess\.thecvf\.com'
            --exclude 'papers\.nips\.cc'
            --exclude 'proceedings\.mlr\.press'
            --exclude 'ieeexplore\.ieee\.org'
            --exclude 'dl\.acm\.org'
            --exclude 'springer\.com'
            --exclude 'nature\.com'
            --exclude 'science\.org'
            --exclude 'tensorflow\.org'
            --exclude 'mathworks\.com'
            --exclude 'udacity\.com'
            --exclude 'coursera\.org'
            --exclude 'techrepublic\.com'
            --exclude 'tesla\.com'
            --exclude 'uber\.com'
            --exclude 'staff\.qut\.edu\.au'
            --exclude 'services\.anu\.edu\.au'
            --exclude 'dmi\.usherb\.ca'
            --exclude 'ri\.cmu\.edu'
            --exclude 'www3\.oculus\.com'
            --exclude 'webdiis\.unizar\.es'
            --exclude 'coraldrowningdetection\.com'
            --exclude 'jiajunwu\.com'
            --exclude 'people\.lu\.usi\.ch'
            --exclude 'cs\.ox\.ac\.uk'
            --exclude '\.edu/'
            --exclude 'mit\.edu'
            --exclude 'stanford\.edu'
            --exclude 'berkeley\.edu'
            --exclude 'cmu\.edu'
            --exclude 'ox\.ac\.uk'
            --exclude 'youtube\.com'
            --exclude 'youtu\.be'
            --exclude 'medium\.com'
            --exclude 'towardsdatascience\.com'
            --exclude 'wikipedia\.org'
            --exclude 'doi\.org'
            --timeout 45
            --max-retries 5
            --base https://itzikbs.com
            '_site/**/*.html'
          fail: true  # Fail the PR if broken internal links are found
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Comment on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const workflowUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ”— Internal Link Check Failed\n\n` +
                    `Broken internal links were detected in this PR.\n\n` +
                    `**These must be fixed before merging.**\n\n` +
                    `**Workflow Run:** ${workflowUrl}\n\n` +
                    `Please review the workflow logs for details about the broken links.\n\n` +
                    `ðŸ’¡ **Tip:** Internal links include:\n` +
                    `- Relative paths (e.g., \`/blog/post.html\`, \`../about.html\`)\n` +
                    `- Same-domain links (e.g., \`https://itzikbs.com/contact.html\`)\n\n` +
                    `External links are checked separately in nightly builds.`
            });
